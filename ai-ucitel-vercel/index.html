<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Učitel – hlasový web</title>
  <style>
    :root{--bg:#0b1020;--panel:#121a33;--ink:#e8ecff;--muted:#a9b1d6;--accent:#7aa2f7;--ok:#9ece6a;--warn:#e0af68;--err:#f7768e}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0e1630);color:var(--ink);font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    .wrap{max-width:960px;margin:0 auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font-size:22px;margin:0}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.35)}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .controls{padding:16px;display:grid;grid-template-columns:1fr auto auto;gap:12px;align-items:center}
    .controls .selects{display:flex;gap:8px;flex-wrap:wrap}
    select,input,button,textarea{border-radius:12px;border:1px solid rgba(255,255,255,.08);background:#0f1730;color:var(--ink);padding:10px 12px}
    button{cursor:pointer}
    button.primary{background:var(--accent);color:#0b1020;border:none}
    button.ghost{background:#0f1730}
    button:disabled{opacity:.5;cursor:not-allowed}
    .status{font-size:13px;color:var(--muted)}
    .chat{padding:0 16px 16px;max-height:60vh;overflow:auto}
    .msg{display:flex;gap:12px;margin:12px 0}
    .bubble{padding:12px 14px;border-radius:14px;max-width:75%}
    .user .bubble{background:#1a2448}
    .assistant .bubble{background:#13234a}
    .role{font-size:12px;color:var(--muted)}
    .hint{font-size:13px;color:var(--muted);padding:8px 16px}
    .footer{padding:12px 16px;display:flex;gap:8px}
    .footer textarea{flex:1;min-height:44px;resize:vertical}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;background:#0f1730;border:1px solid rgba(255,255,255,.08)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>AI Učitel (hlas ↔ AI)</h1>
      <div class="pill" id="sttStatus">🎙️ Připraveno</div>
    </header>

    <section class="card">
      <div class="controls">
        <div class="selects">
          <label>
            Předmět
            <select id="subject">
              <option>Matematika</option>
              <option>Český jazyk</option>
              <option>Angličtina</option>
              <option>Přírodopis</option>
              <option>Fyzika</option>
              <option>Dějepis</option>
            </select>
          </label>
          <label>
            Styl učitele
            <select id="style">
              <option>Trpělivý a povzbudivý</option>
              <option>Roblox průvodce</option>
              <option>Stručný trenér</option>
              <option>Vypravěč s příklady</option>
            </select>
          </label>
          <label>
            Hlas (TTS)
            <select id="voiceSelect"></select>
          </label>
        </div>
        <div class="actions">
          <button id="micBtn" class="primary">Spustit mikrofon</button>
          <button id="stopBtn" class="ghost">Zastavit</button>
        </div>
        <div class="status" id="status">Nastav předmět, klikni na „Spustit mikrofon“ a ptej se.</div>
      </div>
      <div class="chat" id="chat"></div>
      <div class="footer">
        <textarea id="textInput" placeholder="Nebo napiš dotaz… (Ctrl+Enter pro odeslání)"></textarea>
        <button id="sendBtn" class="primary">Odeslat</button>
      </div>
      <div class="hint">Tvoje data se posílají přes endpoint <code>/api/chat</code>. Backend je součástí tohoto balíčku (Vercel Edge) – jen nastav proměnnou <code>OPENAI_API_KEY</code> při deployi.</div>
    </section>
  </div>

  <script>
    function buildSystemPrompt() {
      const subj = document.getElementById('subject').value;
      const style = document.getElementById('style').value;
      return `Jsi český hlasový lektor pro 7. třídu. Předmět: ${subj}. Styl: ${style}.\n` +
        `Mluv česky přátelsky, jednoduše a strukturovaně. Ptej se po malých krocích, ` +
        `čekej na odpověď žáka, chval snahu, opravuj jemně. Používej krátké věty. ` +
        `Když žák odpoví, nejprve shrň, co řekl, pak vysvětli rozdíl, dej 1–2 příklady ` +
        `a nakonec polož jednu jednoduchou kontrolní otázku.`;
    }

    const voiceSelect = document.getElementById('voiceSelect');
    let voices = [];
    function loadVoices() {
      voices = speechSynthesis.getVoices();
      voiceSelect.innerHTML = '';
      const preferred = voices.filter(v => v.lang && v.lang.toLowerCase().startsWith('cs'));
      const list = preferred.length ? preferred : voices;
      list.forEach((v,i)=>{
        const opt = document.createElement('option');
        opt.value = v.name; opt.textContent = `${v.name} (${v.lang})`;
        voiceSelect.appendChild(opt);
      });
    }
    window.speechSynthesis.onvoiceschanged = loadVoices;
    loadVoices();
    function speak(text){
      const u = new SpeechSynthesisUtterance(text);
      const name = voiceSelect.value;
      const chosen = voices.find(v=>v.name===name);
      if(chosen){ u.voice = chosen; }
      u.lang = (chosen && chosen.lang) || 'cs-CZ';
      u.rate = 1.0; u.pitch = 1.0; u.volume = 1.0;
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }

    const sttStatus = document.getElementById('sttStatus');
    let recognition;
    let listening = false;
    function initSTT(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR) { sttStatus.textContent = '⚠️ STT není v tomto prohlížeči podporováno'; return; }
      recognition = new SR();
      recognition.lang = 'cs-CZ';
      recognition.interimResults = true;
      recognition.continuous = true;
      recognition.onstart = ()=>{ sttStatus.textContent = '🎙️ Naslouchám…'; };
      recognition.onerror = (e)=>{ sttStatus.textContent = '⚠️ Chyba mikrofonu: '+ e.error; };
      recognition.onend = ()=>{ sttStatus.textContent = '⏹️ Zastaveno'; listening=false; };
      recognition.onresult = (e)=>{
        let interim = '';
        let final = '';
        for(let i=e.resultIndex; i<e.results.length; i++){
          const r = e.results[i];
          (r.isFinal ? final : interim) += r[0].transcript;
        }
        if(interim) setStatus('📌 '+interim.trim());
        if(final){
          addMessage('user', final.trim());
          sendToAI(final.trim());
        }
      };
    }
    initSTT();

    const chatEl = document.getElementById('chat');
    function addMessage(role, content){
      const msg = document.createElement('div');
      msg.className = 'msg '+role;
      msg.innerHTML = `<div class="role">${role==='user'?'Ty':'Učitel'}</div><div class="bubble">${escapeHtml(content)}</div>`;
      chatEl.appendChild(msg); chatEl.scrollTop = chatEl.scrollHeight;
    }
    function setStatus(text){ document.getElementById('status').textContent = text; }
    function escapeHtml(s){ return s.replace(/[&<>]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }

    const history = [];

    async function sendToAI(userText){
      setStatus('⏳ Přemýšlím…');
      history.push({ role:'user', content:userText });
      const body = { system: buildSystemPrompt(), messages: history };
      try{
        const res = await fetch('/api/chat', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        if(!res.ok){ throw new Error('HTTP '+res.status); }
        const data = await res.json();
        const reply = (data.text || '').trim();
        history.push({ role:'assistant', content: reply });
        addMessage('assistant', reply);
        speak(reply);
        setStatus('✅ Hotovo');
      }catch(err){
        console.error(err);
        setStatus('❌ Chyba: '+err.message + ' – zkontroluj backend /api/chat');
        addMessage('assistant', 'Došlo k chybě při volání AI. Zkontroluj serverovou část.');
      }
    }

    const micBtn = document.getElementById('micBtn');
    const stopBtn = document.getElementById('stopBtn');
    micBtn.onclick = ()=>{
      if(!recognition){ initSTT(); return; }
      if(listening){ return; }
      listening = true; recognition.start(); setStatus('🎙️ Naslouchám… mluv.');
    };
    stopBtn.onclick = ()=>{ if(recognition && listening){ recognition.stop(); } };

    const sendBtn = document.getElementById('sendBtn');
    const textInput = document.getElementById('textInput');
    sendBtn.onclick = ()=>{
      const t = textInput.value.trim(); if(!t) return; textInput.value=''; addMessage('user', t); sendToAI(t);
    };
    textInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); sendBtn.click(); } });

    addMessage('assistant', 'Ahoj! Jsem tvůj AI učitel. Jaké téma bys chtěl dnes procvičit?');
  </script>
</body>
</html>
